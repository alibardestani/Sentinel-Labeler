<!doctype html>
<html lang="en" dir="ltr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>{% block title %}Sentinel Labeler{% endblock %}</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/app.css') }}" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet-draw/dist/leaflet.draw.css" />
  <style>
    :root{--brand:#4f46e5;--bg:#0f1420;--pane:#141a28;--text:#e7ecf3;--muted:#9aa3b2;--radius:12px;--line:#1c2435;--btn:#1b2233;--btnh:#20283b}
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font:14px/1.6 ui-sans-serif,system-ui,Segoe UI,Roboto}
    a{color:inherit;text-decoration:none}
    .btn{background:var(--btn);border:1px solid var(--btnh);border-radius:10px;padding:8px 10px;cursor:pointer;color:var(--text)}
    .btn.primary{background:var(--brand);border-color:var(--brand);color:#fff}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .pill{display:flex;align-items:center;gap:8px;background:#101728;border:1px solid #1e2639;border-radius:999px;padding:6px 10px}
    .app{display:grid;grid-template-columns:220px 1fr 260px;gap:10px;min-height:100vh;grid-template-rows:auto 1fr;grid-template-areas:"header header header" "left main right"}
    header{grid-area:header;display:flex;align-items:center;gap:12px;padding:10px 14px;border-bottom:1px solid var(--line);background:#0d1320;position:sticky;top:0;z-index:20}
    header .brand{display:flex;align-items:center;gap:10px;font-weight:700}
    header .brand img{width:28px;height:28px;object-fit:contain;border-radius:6px}
    header .spacer{flex:1}
    .toolbar{display:flex;gap:8px;flex-wrap:wrap}
    .muted{color:var(--muted)}
    aside.left,aside.right{padding:12px;background:var(--pane);border-radius:var(--radius);border:1px solid var(--line)}
    aside.left{grid-area:left}
    aside.right{grid-area:right}
    main{grid-area:main;padding:10px;padding-right:0}
    .section{display:flex;flex-direction:column;gap:8px;margin-bottom:14px}
    .section .toolbar .btn{padding:6px 9px}
    .map-wrap{height:calc(100vh - 110px)}
    #map{position:relative;height:100%;border-radius:14px;overflow:hidden;border:1px solid var(--line);background:#0b0f19}
    #maskCanvas,#cursorCanvas{position:absolute;inset:0;width:100%;height:100%;pointer-events:none;z-index:800}
    body.tool-brush #maskCanvas{pointer-events:auto}
    .leaflet-top,.leaflet-bottom,.leaflet-control-container{z-index:1200}
    #map .leaflet-control-container{transform:none !important}
    .leaflet-bar a,.leaflet-bar a:hover{display:block;width:26px;height:26px;line-height:26px;padding:0;border-radius:0;box-shadow:none;box-sizing:content-box}
    .leaflet-draw-toolbar a{width:26px !important;height:26px !important;line-height:26px !important;padding:0 !important;border-radius:0 !important;background:#fff;border:1px solid #cfd6e4}
    .leaflet-draw-toolbar a:hover{background:#f3f4f6}
    input[type="range"]{accent-color:var(--brand)}
    code{background:#0f1626;border:1px solid #23304a;border-radius:6px;padding:0 6px}
    .brand{display:flex;align-items:center;gap:8px;font-weight:600;font-size:18px}
    .logo-wrap{background:#fff;padding:6px;border-radius:8px;box-shadow:0 2px 6px rgba(0,0,0,.15);display:flex;align-items:center;justify-content:center}
    .logo-wrap img{width:40px;height:40px;object-fit:contain}
  </style>
  {% block head %}{% endblock %}
</head>
<body>
  <div class="app">
    <header>
      <div class="brand">
        <div class="logo-wrap"><img src="{{ url_for('static', filename='img/logo.png') }}" alt="Logo"></div>
        <div>Sentinel Labeler</div>
      </div>
      <div class="spacer"></div>
      <div class="brush-controls {% block mask_controls_class %}hidden{% endblock %}">
        <div class="pill">
          <label for="brushSize">Size</label>
          <input id="brushSize" type="number" min="1" max="256" value="{{ brush_size|default(16) }}" />
        </div>
        <div class="pill">
          <label for="brushShape">Shape</label>
          <select id="brushShape">
            <option value="circle" {% if brush_shape=='circle' %}selected{% endif %}>Circle</option>
            <option value="square" {% if brush_shape=='square' %}selected{% endif %}>Square</option>
          </select>
        </div>
        <button class="btn" id="saveMaskBtn">Save Mask</button>
      </div>
    </header>

    <aside class="left">
      <div class="section">
        <div class="muted">Pages</div>
        <div class="toolbar">
          <a class="btn" href="/polygon">Polygon</a>
          <a class="btn" href="/brush">Brush</a>
        </div>
      </div>

      <div class="section">
        <div class="muted">Sentinel Scene</div>
        <div class="toolbar" style="gap:8px;align-items:center">
          <select id="sceneSelect" style="min-width:220px"></select>
          <button id="sceneApplyBtn" class="btn">Load Image</button>
        </div>
        <div class="muted" style="font-size:12px">
          Scenes are read from <code>{{ settings.SCENES_DIR if settings and settings.SCENES_DIR else 'SCENES_DIR' }}</code>. Put <code>.zip</code> or <code>.SAFE</code> here.
        </div>
      </div>

      {% block left_panel %}{% endblock %}
      {% block left_extra %}{% endblock %}
    </aside>

    <main>
      {% block main %}
      <div class="map-wrap">
        <div id="map" class="map">
          <canvas id="maskCanvas"></canvas>
          <canvas id="cursorCanvas"></canvas>
        </div>
      </div>
      {% endblock %}
    </main>

    <aside class="right">
      {% block right_panel %}{% endblock %}

      <div class="section">
        <div class="muted">Sentinel Opacity</div>
        <div class="toolbar" style="align-items:center;gap:8px">
          <input id="overlayOpacity" type="range" min="0" max="100" value="60" />
          <span id="opacityValue">0.60</span>
        </div>
      </div>
    </aside>
  </div>

  <div id="sceneProgress" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,.55); z-index:9999; align-items:center; justify-content:center;">
    <div style="min-width:360px; background:#0f1524; border:1px solid #1f2840; border-radius:14px; padding:16px;">
      <div id="sceneProgressTitle" style="font-weight:600; margin-bottom:10px;">Loading scene… (0%)</div>
      <div style="height:10px; background:#222833; border-radius:999px; overflow:hidden;">
        <div id="sceneProgressBar" style="width:0%; height:100%; background:#4f46e5; transition:width .25s;"></div>
      </div>
      <div id="sceneProgressNote" style="margin-top:10px; font-size:12px; color:#9aa3b2;">Please wait…</div>
    </div>
  </div>

  <script src="{{ url_for('static', filename='js/common.js') }}"></script>
  <script src="{{ url_for('static', filename='js/brush/core.js') }}" defer></script>
  <script src="{{ url_for('static', filename='js/brush/io.js') }}" defer></script>
  <script src="{{ url_for('static', filename='js/brush/ui.js') }}" defer></script>
  {% block scripts %}{% endblock %}

  <script>
    (function(){
      const sel = document.getElementById('sceneSelect');
      const btn = document.getElementById('sceneApplyBtn');
      const modal = document.getElementById('sceneProgress');
      const tEl = document.getElementById('sceneProgressTitle');
      const bEl = document.getElementById('sceneProgressBar');
      const nEl = document.getElementById('sceneProgressNote');
      let pollTimer = null;

      function showProgress() {
        modal.style.display = 'flex';
        tEl.textContent = 'Loading scene… (0%)';
        bEl.style.width = '0%';
        nEl.textContent = 'Please wait…';
      }
      function hideProgress() {
        modal.style.display = 'none';
      }
      async function pollProgress() {
        try {
          const r = await fetch('/api/progress', { cache: 'no-store' });
          if (!r.ok) return;
          const j = await r.json();
          const pct = Math.max(0, Math.min(100, Number(j.percent || 0)));
          bEl.style.width = pct + '%';
          tEl.textContent = (j.phase ? j.phase : 'Processing') + ' (' + pct.toFixed(0) + '%)';
          nEl.textContent = j.note || '';
        } catch {}
      }
      function startPolling() {
        stopPolling();
        pollTimer = setInterval(pollProgress, 400);
      }
      function stopPolling() {
        if (pollTimer) { clearInterval(pollTimer); pollTimer = null; }
      }

      async function loadList(){
        try{
          const r = await fetch('/api/scenes/list', { cache: 'no-store' });
          const j = await r.json();
          sel.innerHTML = '';
          if (!j.ok) { btn.disabled = true; return; }
          const items = j.items || [];
          if (!items.length){
            const op = document.createElement('option');
            op.value = ''; op.textContent = 'No scenes found';
            sel.appendChild(op);
            btn.disabled = true;
            return;
          }
          for (const it of items){
            const op = document.createElement('option');
            op.value = it.id;
            const tag = [it.tile || '', it.date || ''].filter(Boolean).join(' • ');
            op.textContent = `${it.name}${tag ? ' — ' + tag : ''}`;
            sel.appendChild(op);
          }
          btn.disabled = false;
        }catch{
          btn.disabled = true;
        }
      }

      async function applyScene(){
        const id = sel.value;
        if (!id) return;
        btn.disabled = true;
        btn.textContent = 'Loading...';
        showProgress();
        startPolling();
        try{
          const r = await fetch('/api/scenes/select', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ scene_id: id })
          });
          const j = await r.json().catch(() => ({}));
          if (!r.ok || !j.ok){
            alert('Select failed' + (j.error ? ': ' + j.error : ''));
            return;
          }
          await pollProgress();
          stopPolling();
          hideProgress();
          location.reload();
        }catch{
          stopPolling();
          hideProgress();
          alert('Select failed');
        }finally{
          btn.textContent = 'Load Image';
          btn.disabled = false;
        }
      }

      btn?.addEventListener('click', applyScene);
      loadList();
    })();

    (function(){
      const opacitySlider = document.getElementById('overlayOpacity');
      const opacityVal = document.getElementById('opacityValue');
      function apply(){
        const v = (parseInt(opacitySlider.value, 10) || 60) / 100;
        if (window.BrushApp?.overlay?.setOpacity) window.BrushApp.overlay.setOpacity(v);
        if (opacityVal) opacityVal.textContent = v.toFixed(2);
      }
      opacitySlider?.addEventListener('input', apply);
      apply();
    })();
  </script>
</body>
</html>