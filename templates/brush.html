{% extends 'base.html' %}
{% block title %}Brush — Sentinel Labeler{% endblock %}

{% block head %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.css" />
<style>
  .map-wrap {
    height: calc(100vh - 110px);
  }

  #map {
    position: relative;
    height: 100%;
    border-radius: 14px;
    overflow: hidden;
    border: 1px solid #1c2435;
    background: #0d1320; /* وقتی بیسمپ دیر لود شد، صفحه سیاه مطلق نباشه */
  }

  /* کانواس‌ها */
  #maskCanvas,
  #cursorCanvas {
    position: absolute;
    inset: 0;
    width: 100%;
    height: 100%;
    pointer-events: none; /* پیش‌فرض غیرفعاله */
  }

  #maskCanvas { z-index: 1306; }
  #cursorCanvas { z-index: 1307; }

  /* وقتی براش روشن است، ماسک کلیک‌پذیر شود */
  body.tool-brush #maskCanvas { pointer-events: auto; }

  /* لایه‌های Leaflet پایین‌تر از کانواس‌ها */
  #map .leaflet-overlay-pane,
  #map .leaflet-vector-pane {
    z-index: 1302;
  }

  /* کنترل‌های Leaflet بالاتر از همه */
  .leaflet-top,
  .leaflet-bottom,
  .leaflet-control-container {
    z-index: 1400;
  }

  /* HUD و چیپ‌ها (استایل‌های دم‌دستی) */
  .hud {
    display: grid;
    gap: 8px;
    grid-template-columns: 1fr auto;
    align-items: center;
    padding: 8px;
    border: 1px solid var(--line);
    background: var(--pane);
    border-radius: 10px;
  }
  .hud .row {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
    align-items: center;
  }
  .chip {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    background: #101728;
    border: 1px solid #1e2639;
    padding: 4px 8px;
    border-radius: 999px;
  }
  .num { font-variant-numeric: tabular-nums; }
  .kbd {
    background: #0f1626;
    border: 1px solid #23304a;
    padding: 0 6px;
    border-radius: 6px;
    font-size: 12px;
  }

  /* فرم متادیتا (سایدبار چپ) */
  .section .toolbar label {
    display: grid;
    gap: 6px;
  }
</style>
{% endblock %}

{% block main %}
<div class="map-wrap">
  <div id="map" class="map">
    <canvas id="maskCanvas"></canvas>
    <canvas id="cursorCanvas"></canvas>
  </div>
</div>
{% endblock %}

{% block left_panel %}
<!-- Polygon Properties (سایدبار چپ) -->
<div class="section">
  <div class="muted">Polygon Properties</div>
  <div class="toolbar" style="gap:10px; flex-wrap:wrap">
    <label style="flex:1 1 100%">UID
      <input id="polyUid" type="text" style="width:100%" readonly>
    </label>

    <label style="flex:1 1 100%">Fruit Type
      <input id="polyUsesFruit" type="text" style="width:100%">
    </label>

    <label style="flex:1 1 100%">Code
      <input id="polyCode" type="text" style="width:100%">
    </label>

    <label>Area (m²)
      <input id="polyAreaM2" type="number" step="0.01" readonly>
    </label>

    <label>Lat
      <input id="polyLat" type="number" step="0.000001" readonly>
    </label>

    <label>Lon
      <input id="polyLon" type="number" step="0.000001" readonly>
    </label>

    <label style="flex:1 1 100%">Label
      <select id="polyLabelSelect" style="width:100%">
        <option value="">—</option>
        <option value="veg">Vegetation</option>
        <option value="background">Background</option>
        <option value="__custom__">Custom…</option>
      </select>
      <div id="customLabelWrap" style="display:none; margin-top:6px;">
        <input id="polyLabelCustom" type="text" placeholder="Custom label" style="width:100%">
      </div>
    </label>

    <label>Class ID
      <input id="polyClass" type="number" min="0" step="1" value="1">
    </label>

    <label>Color
      <input id="polyColor" type="color" value="#00ff00">
    </label>

    <div class="pill" style="gap:8px">
      <button id="applyPropsBtn" class="btn">Apply</button>
      <button id="savePolygonsBtn" class="btn primary">Save All</button>
    </div>
  </div>
</div>
{% endblock %}

{% block right_panel %}
{{ super() }}

<!-- HUD: tile & progress -->
<div class="section">
  <div class="hud">
    <div class="row">
      <span class="chip">Tile: <b id="hudTile">-</b></span>
      <span class="chip">Poly: <span id="hudIndex" class="num">0</span>/<span id="hudTotal" class="num">0</span></span>
      <span class="chip">Done: <span id="hudDone" class="num">0</span></span>
    </div>
    <div class="row">
      <button id="btnPrev" class="btn">Prev (P)</button>
      <button id="btnNext" class="btn">Next (N)</button>
    </div>
  </div>
</div>

<!-- Mode -->
<div class="section">
  <div class="muted">Mode</div>
  <div class="toolbar" style="gap:8px; flex-wrap:wrap">
    <button id="modePanBtn2" class="btn">Pan (V)</button>
    <button id="modeBrushBtn2" class="btn primary">Brush (B)</button>
  </div>
</div>

<!-- Brush -->
<div class="section">
  <div class="muted">Brush</div>
  <div class="toolbar" style="gap:10px; flex-wrap:wrap; align-items:center">
    <label>Size
      <input id="brushSize2" type="range" min="2" max="128" step="1" value="24" />
      <span id="brushSizeVal2">24 px</span>
    </label>
    <label style="display:flex;align-items:center;gap:6px;">
      <input id="eraseChk2" type="checkbox" />
      Erase (E)
    </label>
    <button id="clearMask2" class="btn">Clear</button>
    <button id="btnMarkDone" class="btn">Mark done (L)</button>
    <button id="savePng2" class="btn primary">Save PNG (S)</button>
  </div>
  <div class="muted" style="font-size:12px;margin-top:6px;">
    Shortcuts: <span class="kbd">B</span>/<span class="kbd">V</span> • <span class="kbd">[</span>/<span
      class="kbd">]</span> size • <span class="kbd">E</span> erase • <span class="kbd">N</span>/<span
      class="kbd">P</span> next/prev • <span class="kbd">L</span> done • <span class="kbd">S</span> save
  </div>
</div>

<!-- Polygons -->
<div class="section">
  <div class="muted">Polygons</div>
  <div class="toolbar" style="gap:8px; flex-wrap:wrap">
    <input type="file" id="polyUpload2" accept=".geojson,.json,.zip" />
    <button id="loadPolygonsBtn2" class="btn">Upload</button>
  </div>
  <div class="muted" style="font-size:12px">
    Auto-loads from <code>/api/polygons</code>. Features ideally have
    <code>tile_id</code>, <code>code</code>, <code>uses_fruit</code>, <code>uid</code>.
  </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" defer></script>
<script src="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.js" defer></script>

<script src="{{ url_for('static', filename='js/brush/core.js') }}" defer></script>
<script src="{{ url_for('static', filename='js/brush/io.js') }}" defer></script>
<script src="{{ url_for('static', filename='js/brush/ui.js') }}" defer></script>

<!-- Wiring: بعد از لود سه فایل بالا -->
<script>
  window.addEventListener('DOMContentLoaded', async () => {
    console.log('[BRUSH] bootstrap start');
    try {
      await window.BrushApp.init({
        mapId: 'map',
        maskId: 'maskCanvas',
        cursorId: 'cursorCanvas',
        enforceClip: true,
        overlayBoundsURL: '/api/s2_bounds_wgs84',
        overlayImageURL: '/api/output/rgb_quicklook.png'
      });

      // فلگ آماده بودن برای ui.js
      window.BrushApp.ready = true;

      // به ui.js سیگنال بده برای وایر شدن
      window.dispatchEvent(new Event('brush:ready'));

      console.log('[BRUSH] bootstrap done');
    } catch (e) {
      console.error('[BRUSH] bootstrap failed', e);
      if (window.BrushApp.map) {
        window.BrushApp.map.setView([30.0, 52.0], 12);
      }
    }
  });
</script>

<!-- متادیتا: پر/خواندن فرم از/به لایه انتخابی -->
<script>
(function () {
  const $ = (id) => document.getElementById(id);

  function safeGetApp() { return window.BrushApp; }
  function safeGetIO()  { return window.BrushIO; }

  const elUid   = $('polyUid');
  const elUses  = $('polyUsesFruit');
  const elCode  = $('polyCode');
  const elArea  = $('polyAreaM2');
  const elLat   = $('polyLat');
  const elLon   = $('polyLon');

  const elLabelSel    = $('polyLabelSelect');
  const elCustomWrap  = $('customLabelWrap');
  const elLabelCustom = $('polyLabelCustom');

  const elClass = $('polyClass');
  const elColor = $('polyColor');

  const btnApply   = $('applyPropsBtn');
  const btnSaveAll = $('savePolygonsBtn');

  function showCustomIfNeeded() {
    const v = elLabelSel?.value || '';
    if (!elCustomWrap) return;
    elCustomWrap.style.display = (v === '__custom__') ? 'block' : 'none';
  }
  elLabelSel?.addEventListener('change', showCustomIfNeeded);

  function computeAreaM2(layer) {
    try {
      const latlngs = layer.getLatLngs();
      const rings = (Array.isArray(latlngs[0]) && Array.isArray(latlngs[0][0])) ? latlngs : [latlngs];
      let sum = 0;
      for (const poly of rings) {
        const ring = (Array.isArray(poly) && Array.isArray(poly[0])) ? poly[0] : poly;
        sum += L.GeometryUtil.geodesicArea(ring);
      }
      return Math.max(0, sum);
    } catch { return 0; }
  }

  function populateFormFromLayer(layer) {
    if (!layer) return;
    const p = layer._props || {};
    // UID
    if (elUid) elUid.value = p.uid || layer?.feature?.properties?.uid || String(layer?._leaflet_id || '');
    // props شناخته‌شده
    if (elUses)  elUses.value  = p.uses_fruit || '';
    if (elCode)  elCode.value  = p.code || '';
    if (elClass) elClass.value = (p.class_id != null ? p.class_id : 1);
    if (elColor) elColor.value = p.color || '#00ff00';
    // label (custom یا آماده)
    const label = p.label || '';
    if (elLabelSel) {
      if (['veg','background',''].includes(label)) {
        elLabelSel.value = label;
        if (elLabelCustom) elLabelCustom.value = '';
      } else {
        elLabelSel.value = '__custom__';
        if (elLabelCustom) elLabelCustom.value = label;
      }
      showCustomIfNeeded();
    }
    // مرکز تقریبی
    try {
      const ctr = layer.getBounds().getCenter();
      if (elLat) elLat.value = Number(ctr.lat.toFixed(6));
      if (elLon) elLon.value = Number(ctr.lng.toFixed(6));
    } catch {
      if (elLat) elLat.value = '';
      if (elLon) elLon.value = '';
    }
    // مساحت
    if (elArea) elArea.value = Math.round(computeAreaM2(layer) * 100) / 100;
  }

  function readFormToProps(layer) {
    if (!layer) return;
    layer._props ||= {};
    const p = layer._props;

    p.uid        = elUid?.value || p.uid || layer?.feature?.properties?.uid;
    p.uses_fruit = elUses?.value || '';
    p.code       = elCode?.value || '';

    const sel = elLabelSel?.value || '';
    p.label = (sel === '__custom__') ? (elLabelCustom?.value || '') : sel;

    p.class_id = parseInt(elClass?.value || '1', 10) || 1;
    p.color    = elColor?.value || '#00ff00';

    try { layer.setStyle?.({ color: p.color, weight: 2 }); } catch {}
  }

  // وقتی لایه انتخاب شد، فرم را پر کن
  function hookOnLayerSelected() {
    const App = safeGetApp();
    if (!App) return;

    const prev = App.onLayerSelected;
    App.onLayerSelected = (layer) => {
      try { prev && prev(layer); } catch {}
      populateFormFromLayer(layer);
    };

    // اگر همین حالا هم لایه‌ای انتخاب است
    if (App.selectedLayer) populateFormFromLayer(App.selectedLayer);
  }

  // دکمه Apply: فقط روی همین لایه
  function wireButtons() {
    const App = safeGetApp();
    const IO  = safeGetIO();

    btnApply?.addEventListener('click', () => {
      const layer = IO?.current?.() || App?.selectedLayer;
      if (!layer) return;
      readFormToProps(layer);
    });

    // Save All: کل لایه‌ها به /api/save_polygons
    btnSaveAll?.addEventListener('click', async () => {
      try {
        const cur = IO?.current?.() || App?.selectedLayer;
        if (cur) readFormToProps(cur);

        const features = [];
        for (const ly of (App?.layers || [])) {
          const gj = ly.toGeoJSON();
          gj.properties = { ...(ly._props || {}) };
          features.push(gj);
        }
        const fc = { type: 'FeatureCollection', features };
        const r = await fetch('/api/save_polygons', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(fc),
        });
        if (!r.ok) throw new Error('HTTP ' + r.status);
        alert('Polygons saved.');
      } catch (e) {
        console.error('savePolygons:error', e);
        alert('Save failed: ' + e);
      }
    });
  }

  // وایرینگ بعد از آماده‌شدن اپ
  function readyOrWait() {
    const App = safeGetApp();
    if (App?.map) {
      hookOnLayerSelected();
      wireButtons();
    } else {
      window.addEventListener('brush:ready', () => {
        hookOnLayerSelected();
        wireButtons();
      }, { once: true });
    }
  }

  readyOrWait();
})();
</script>
{% endblock %}