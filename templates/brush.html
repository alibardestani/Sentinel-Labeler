{% extends 'base.html' %}
{% block title %}Brush — Sentinel Labeler{% endblock %}

{% block head %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.css" />
<style>
  .map-wrap { height: calc(100vh - 110px) }
  #map { position: relative; height: 100%; border-radius: 14px; overflow: hidden; border: 1px solid #1c2435; background: #0d1320 }
  #maskCanvas, #cursorCanvas { position: absolute; inset: 0; width: 100%; height: 100%; pointer-events: none }
  #maskCanvas { z-index: 1306 }
  #cursorCanvas { z-index: 1307 }
  body.tool-brush #maskCanvas { pointer-events: auto }
  .leaflet-top, .leaflet-bottom, .leaflet-control-container { z-index: 1400 }
  .section .toolbar label { display: grid; gap: 6px }
  .hud { display: grid; gap: 8px; grid-template-columns: 1fr auto; align-items: center; padding: 8px; border: 1px solid var(--line); background: var(--pane); border-radius: 10px }
  .hud .row { display: flex; gap: 8px; flex-wrap: wrap; align-items: center }
  .chip { display: inline-flex; align-items: center; gap: 6px; background: #101728; border: 1px solid #1e2639; padding: 4px 8px; border-radius: 999px }
  .num { font-variant-numeric: tabular-nums }
  .kbd { background: #0f1626; border: 1px solid #23304a; padding: 0 6px; border-radius: 6px; font-size: 12px }
  /* tile loader overlay */
  #tileLoader { position: absolute; inset: 0; display: none; place-items: center; background: rgba(13,19,32,.45); z-index: 1405 }
  #tileLoader .box { padding: 10px 14px; border-radius: 10px; background: #0f1626; border: 1px solid #23304a; color: #dbe3f4; font: 14px/1.2 system-ui, sans-serif }
</style>
{% endblock %}

{% block main %}
<div class="map-wrap">
  <div id="map" class="map">
    <canvas id="maskCanvas"></canvas>
    <canvas id="cursorCanvas"></canvas>
    <div id="tileLoader"><div class="box">Loading tile…</div></div>
  </div>
</div>
{% endblock %}

{% block left_panel %}
<!-- همان بخش Polygon Properties بدون تغییر -->
<div class="section">
  <div class="muted">Polygon Properties</div>
  <div class="toolbar" style="gap:10px;flex-wrap:wrap">
    <label style="flex:1 1 100%">UID
      <input id="polyUid" type="text" style="width:100%" readonly>
    </label>
    <label style="flex:1 1 100%">Fruit Type
      <input id="polyUsesFruit" type="text" style="width:100%">
    </label>
    <label style="flex:1 1 100%">Code
      <input id="polyCode" type="text" style="width:100%">
    </label>
    <label>Area (m²)
      <input id="polyAreaM2" type="number" step="0.01" readonly>
    </label>
    <label>Lat
      <input id="polyLat" type="number" step="0.000001" readonly>
    </label>
    <label>Lon
      <input id="polyLon" type="number" step="0.000001" readonly>
    </label>
    <label style="flex:1 1 100%">Label
      <select id="polyLabelSelect" style="width:100%">
        <option value="">—</option>
        <option value="veg">Vegetation</option>
        <option value="background">Background</option>
        <option value="__custom__">Custom…</option>
      </select>
      <div id="customLabelWrap" style="display:none;margin-top:6px">
        <input id="polyLabelCustom" type="text" placeholder="Custom label" style="width:100%">
      </div>
    </label>
    <label>Class ID
      <input id="polyClass" type="number" min="0" step="1" value="1">
    </label>
    <label>Color
      <input id="polyColor" type="color" value="#00ff00">
    </label>
    <div class="pill" style="gap:8px">
      <button id="applyPropsBtn" class="btn">Apply</button>
      <button id="savePolygonsBtn" class="btn primary">Save All</button>
    </div>
  </div>
</div>
{% endblock %}

{% block right_panel %}
{{ super() }}
<!-- همان بخش HUD + Brush + Grid بدون تغییر ساختاری -->
<div class="section">
  <div class="hud">
    <div class="row">
      <span class="chip">Tile: <b id="hudTileRC">-</b></span>
      <span class="chip">Poly: <span id="hudIndex" class="num">0</span>/<span id="hudTotal" class="num">0</span></span>
      <span class="chip">Done: <span id="hudDone" class="num">0</span></span>
    </div>
    <div class="row">
      <button id="btnPrev" class="btn">Prev (P)</button>
      <button id="btnNext" class="btn">Next (N)</button>
    </div>
  </div>
</div>

<div class="section">
  <div class="muted">Mode</div>
  <div class="toolbar" style="gap:8px;flex-wrap:wrap">
    <button id="modePanBtn2" class="btn">Pan (V)</button>
    <button id="modeBrushBtn2" class="btn primary">Brush (B)</button>
  </div>
</div>

<div class="section">
  <div class="muted">Brush</div>
  <div class="toolbar" style="gap:10px;flex-wrap:wrap;align-items:center">
    <label>Size
      <input id="brushSize2" type="range" min="2" max="128" step="1" value="24" />
      <span id="brushSizeVal2">24 px</span>
    </label>
    <label style="display:flex;align-items:center;gap:6px">
      <input id="eraseChk2" type="checkbox" /> Erase (E)
    </label>
    <label>Class
      <select id="brushClassSelect" style="min-width:160px">
        <option value="3">گردو (قهوه‌ای)</option>
        <option value="4">(سبز پسته‌ای)پسته</option>
        <option value="5">نخیلات (سبز تیره)</option>
        <option value="6">مرکبات (نارنجی)</option>
        <option value="7">سیب (زرد)</option>
        <option value="0">Background (پاک)</option>
        <option value="1">پوشش گیاهی پرتراکم</option>
        <option value="2">پوشش گیاهی کم تراکم</option>
      </select>
    </label>
    <button id="clearMask2" class="btn">Clear</button>
    <button id="btnMarkDone" class="btn">Mark done (L)</button>
    <button id="savePng2" class="btn primary">Save PNG (S)</button>
  </div>
  <div class="muted" style="font-size:12px;margin-top:6px">
    Shortcuts: <span class="kbd">B</span>/<span class="kbd">V</span> • <span class="kbd">[</span>/<span class="kbd">]</span> size •
    <span class="kbd">E</span> erase • <span class="kbd">N</span>/<span class="kbd">P</span> next/prev • <span class="kbd">L</span> done • <span class="kbd">S</span> save
  </div>
</div>

<div class="section">
  <div class="muted">Grid</div>
  <div class="toolbar" style="gap:8px;flex-wrap:wrap;align-items:center">
    <span class="chip">Tile: <b id="hudTileRC2">r1×c1</b></span>
    <button id="tilePrev" class="btn">◀</button>
    <button id="tileNext" class="btn">▶</button>
    <select id="tileSelect"></select>
    <button id="tileGo" class="btn primary">Go</button>
    <label class="chip" style="gap:6px">
      <input id="autoFollowChk" type="checkbox" /> Auto-follow tile
    </label>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
  // --- Global palette ---
  window.BRUSH_PALETTE = {
    0: { name: 'Background',            color: '#00000000' },
    1: { name: 'پوشش گیاهی پرتراکم',   color: '#106c2aff' },
    2: { name: 'پوشش گیاهی کم تراکم',  color: '#7dd37aff' },
    3: { name: 'گردو',                  color: '#8b5a2bff' },
    4: { name: 'پسته',                  color: '#93c572ff' },
    5: { name: 'نخیلات',                color: '#1b5e20ff' },
    6: { name: 'مرکبات',                color: '#ff8c00ff' },
    7: { name: 'سیب',                   color: '#ffd60aff' }
  };
</script>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" defer></script>
<script src="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.js" defer></script>
<script src="{{ url_for('static', filename='js/brush/core.js') }}" defer></script>
<script src="{{ url_for('static', filename='js/brush/io.js') }}" defer></script>
<script src="{{ url_for('static', filename='js/brush/ui.js') }}" defer></script>

<script>
  (function () {
    const $ = (id) => document.getElementById(id);

    // --- Polygon panel (custom label toggle) ---
    function wirePolygonPanel() {
      const sel = $('polyLabelSelect');
      const wrap = $('customLabelWrap');
      function toggle() { wrap.style.display = (sel.value === '__custom__') ? 'block' : 'none'; }
      sel?.addEventListener('change', toggle);
      toggle();
    }

    // --- HUD + Grid sync ---
    function wireGridControls() {
      const A = window.BrushApp;
      const prev = $('tilePrev'), next = $('tileNext'), go = $('tileGo'), sel = $('tileSelect'), chk = $('autoFollowChk');
      const huds = [$('hudTileRC'), $('hudTileRC2')];

      document.addEventListener('brush:tilechange', (ev) => {
        const { r, c } = ev.detail || { r: 0, c: 0 };
        huds.forEach(h => h && (h.textContent = `r${r+1}×c${c+1}`));
        if (sel) sel.value = `${r},${c}`;
      });

      prev?.addEventListener('click', () => A.moveTile(0,-1,{wrap:true,fit:false}));
      next?.addEventListener('click', () => A.moveTile(0,+1,{wrap:true,fit:false}));
      go?.addEventListener('click', () => {
        const [r,c] = (sel?.value||'0,0').split(',').map(n=>parseInt(n,10));
        A.setActiveTile(r,c,{fit:false});
      });

      chk?.addEventListener('change',()=>A.setAutoFollowTiles(!!chk.checked));
      if (typeof A.grid?.autoFollow === 'boolean') chk.checked = !!A.grid.autoFollow;
    }

    // --- Grid dropdown builder ---
    async function populateGridDropdown(sceneId) {
      const sel = $('tileSelect'); if (!sel) return;
      sel.innerHTML = '';
      const list = await fetch(`/api/grid/list?scene_id=${encodeURIComponent(sceneId)}&t=${Date.now()}`,{cache:'no-store'}).then(r=>r.json()).catch(()=>null);
      if (!list || !list.ok) return;
      list.items.sort((a,b)=>(a.r*100+a.c)-(b.r*100+b.c));
      list.items.forEach(it=>{
        const op=document.createElement('option');
        op.value=`${it.r},${it.c}`;
        op.textContent=`r${it.r+1}×c${it.c+1}`;
        sel.appendChild(op);
      });
      sel.value='0,0';
      [$('hudTileRC'),$('hudTileRC2')].forEach(h=>h&&(h.textContent='r1×c1'));
    }

    // --- Scene + tiles bootstrap ---
    async function initBrush() {
      // check auth & access
      const res=await fetch('/api/my_tiles',{cache:'no-store'});
      if(res.status===401){location.href='/login?next='+encodeURIComponent(location.pathname);return;}
      const j=await res.json().catch(()=>null);
      if(!j?.ok||!Array.isArray(j.items)||j.items.length===0){location.href='/no-access';return;}

      // wait until Leaflet + BrushApp are ready
      await new Promise((res,rej)=>{
        const t0=Date.now();(function tick(){if(window.L&&window.BrushApp?.init)return res(true);if(Date.now()-t0>7000)return rej(new Error('timeout'));setTimeout(tick,60);})(); 
      });

      // init brush core
      await window.BrushApp.init({
        mapId:'map',maskId:'maskCanvas',cursorId:'cursorCanvas',
        overlayBoundsURL:'/api/s2_bounds_wgs84',
        gridRows:3,gridCols:3,autoPickVisibleTile:false,autoFollowTiles:false
      });

      // override tile loading overlay
      window.BrushApp.setTileLoading=(on)=>{
        const el=$('tileLoader'); if(el) el.style.display=on?'grid':'none';
      };

      // fetch current scene (یک‌بار)
      const sc=await SceneStore.current().catch(()=>null);
      if(!sc||!sc.ok||!sc.scene){alert('No scene selected');return;}
      const sid=sc.scene.id;

      // ensure grid ready
      const probe=`/api/grid/list?scene_id=${encodeURIComponent(sid)}&t=${Date.now()}`;
      let r=await fetch(probe,{cache:'no-store'});
      if(r.status===404){
        const sel=await fetch('/api/scenes/select',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({scene_id:sid})});
        if(!sel.ok)throw new Error('scenes/select http '+sel.status);
        r=await fetch(probe,{cache:'no-store'});
      }
      if(r.status!==200){alert('Tiles not ready');return;}

      await populateGridDropdown(sid);
      window.BrushApp.setActiveTile(0,0,{fit:true});
      if(window.BrushIO?.reloadPolygonsForScene){try{await window.BrushIO.reloadPolygonsForScene();}catch(e){console.error('polygons:load:error',e);}}
    }

    document.addEventListener('DOMContentLoaded',async()=>{
      try{
        await initBrush();
        wirePolygonPanel();
        wireGridControls();
      }catch(e){console.error(e);alert('Initialization failed: '+e.message);}
    });
  })();
</script>
{% endblock %}