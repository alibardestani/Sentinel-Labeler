{% extends "base.html" %}
{% block title %}Sentinel vs Esri — Project2{% endblock %}

{% block head %}
  {{ super() }}
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="{{ url_for('project2_bp.static', filename='css/style.css') }}">
{% endblock %}

{% block left_panel %}
  <div class="section">
    <div class="muted">Sentinel Scenes</div>
    <div class="toolbar">
      <button id="genPngsBtn" class="btn">Generate PNGs</button>
    </div>
    {% if shapefile_missing %}
      <div class="muted" style="font-size:12px;color:#ffb4a6">
        No shapefile found in <code>/data/polygons/</code>.
      </div>
    {% endif %}
  </div>

  <div class="section">
    <div class="muted">Polygon</div>
    <div class="toolbar">
      <input id="polyIndex" type="number" min="0" step="1" class="btn" placeholder="index (e.g. 0)" style="width:120px">
      <button id="showBtn" class="btn">Show</button>
    </div>
    <div class="muted" style="font-size:12px">Click a polygon or enter index then Show.</div>
  </div>
{% endblock %}

{% block main %}
  <div class="two-col">
    <div id="map"></div>
    <div id="canvasContainer">
      <div class="muted">Sentinel Crop & Polygon (Canvas)</div>
      <canvas id="rgbCanvas"></canvas>
    </div>
  </div>
{% endblock %}

{% block right_panel %}
  <div class="section">
    <div class="muted">Status</div>
    <div id="statusPanel" class="toolbar" style="gap:10px; align-items:center;">
      <span class="chip">Status: <b id="statusText">Unknown</b></span>
      <span class="chip">Reviewed: <b id="statusReviewedText">Pending</b></span>
      <button id="saveBtn" class="btn primary" style="margin-left:auto">Save All</button>
    </div>
    <div class="muted" style="font-size:12px">Right-click a polygon on the map to set status.</div>
  </div>
{% endblock %}

{% block scripts %}
  {{ super() }}
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" defer></script>
  <script>
    window.polygonsData  = {{ polygons_json|safe }};
    window.PROJECT2_BASE = "{{ url_for('project2_bp.index')[:-1] }}";
  </script>
  <script src="{{ url_for('project2_bp.static', filename='js/viewer.js') }}" defer></script>
  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const gen  = document.getElementById("genPngsBtn");
      const show = document.getElementById("showBtn");

      gen?.addEventListener("click", async () => {
        gen.disabled = true; gen.textContent = "Generating…";
        try {
          const r = await fetch(`${window.PROJECT2_BASE}/generate_all_pngs`);
          const j = await r.json().catch(()=>null);
          alert(j?.message || "Triggered");
        } catch (e) {
          alert("Failed to trigger PNG generation.");
        } finally {
          gen.disabled = false; gen.textContent = "Generate PNGs";
        }
      });

      show?.addEventListener("click", async () => {
        const idxEl = document.getElementById("polyIndex");
        const idx = parseInt(idxEl.value, 10);
        if (Number.isNaN(idx)) return alert("Enter a valid index.");

        const r = await fetch(`${window.PROJECT2_BASE}/get_polygon_rgb/${idx}`);
        const d = await r.json();
        if (!r.ok) return alert(d.error || "Not found");

        window.selectedId = idx;
        window.selectedFeature = { properties: { index: idx } };

        if (window.drawImageToCanvas) {
          window.drawImageToCanvas(d.image_path, d.mask_path || null, d.polygon_utm || null, d.bbox || null);
        }
        if (window.onPolygonLoaded) {
          window.onPolygonLoaded(d);
        }
      });

      const saveBtn = document.getElementById("saveBtn");
      saveBtn?.addEventListener("click", async () => {
        try {
          const r = await fetch(`${window.PROJECT2_BASE}/save_all`, { method: "POST" });
        const j = await r.json().catch(()=>null);
          alert(j?.success ? "Shapefile saved." : (j?.error || "Save failed"));
        } catch {
          alert("Save failed.");
        }
      });
    });
  </script>
{% endblock %}